---
title: "Multilevel modelling"
author: "Ida Dencker"
date: "2024-05-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
pacman::p_load(tidyverse, lme4) 

```


```{r}
#load in data
sentiment_data <- read_csv('/Users/idahelenedencker/Desktop/STANDBY/vaders_roberta_bert.csv')

#can check number of distinct values for a column
n_distinct(sentiment_data$name_abbreviation)
```

# Multilevel modelling (predictive modelling)

List of predictors:
- offentlig/privat
- week
- n_post_day
- municipality
- subcomment
- total_n_comments
- total_n_reactions
- count_like
- count_care
- count_heart
- count_haha
- count_sad
- count_angry
- count_wow
- count_heart

sentiment predictors
- neg
- neu
- pos
- compound
- pos_score_roberta
- neg_score_roberta
- neu_score_roberta
- compound_roberta
- roberta_label
- bert_emotion_label 

outcome
- intervention

```{r}
# preprocessing the data

#check class of every column
sapply(sentiment_data, class)

#factorize data
# data that cant be 'integer' numbers and have levels are transformed, e.g we can't have 7,3 weeks or 1,2 municipality == transformed 
sentiment_data <- sentiment_data %>%
  mutate(
    intervention = as.factor(intervention),
    main_post = as.factor(main_post),
    week = as.factor(week),
    subcomment = as.factor(subcomment),
    municipality = as.factor(municipality),
    offentlig_privat = as.factor(offentlig_privat),
    roberta_label = as.factor(roberta_label),
    name_abbreviation = as.factor(name_abbreviation)
  )

#should ID be level??

#check the levels look right 
sapply(sentiment_data, levels)

#can check the number of levels for a factor column
nlevels(sentiment_data$name_abbreviation)

```

#getting an idea of how the data looks, to understand the output of the models better

```{r}
library(ggplot2)
library(gridExtra)

# Plotting positive scores
p1 <- ggplot(sentiment_data, aes(x = intervention, y = pos_score_roberta)) +
  geom_bar(stat = "summary", fun = "mean", fill = "skyblue", color = "black") +
  labs(title = "Positive") +
  theme_minimal()

# Plotting neutral scores
p2 <- ggplot(sentiment_data, aes(x = intervention, y = neu_score_roberta)) +
  geom_bar(stat = "summary", fun = "mean", fill = "lightgreen", color = "black") +
  labs(title = "Neutral") +
  theme_minimal()

# Plotting negative scores
p3 <- ggplot(sentiment_data, aes(x = intervention, y = neg_score_roberta)) +
  geom_bar(stat = "summary", fun = "mean", fill = "salmon", color = "black") +
  labs(title = "Negative") +
  theme_minimal()

# Plotting compound scores
p4 <- ggplot(sentiment_data, aes(x = intervention, y = compound_roberta)) +
  geom_bar(stat = "summary", fun = "mean", fill = "lightgrey", color = "black") +
  labs(title = "Compound") +
  theme_minimal()


# Combining plots
grid.arrange(p1, p2, p3, p4, ncol = 2)


#looking here we see that when the intervention is yes the comments are generally more negative (lower pos score + higher neg score + lower compound score). This is good to know when starting to model the effect of intervention. So looking at this, we expect that an intervention (intervention==yes) will entail a more negative sentiment in comments compared to no intervention (intercention == no)

```


Now we can start on making multilevel logistic regression models predicting intervention, i.e intervention as a function of different predictors

The more complex models have a 3-level design to account for nestedness: post (ID) nested in politicians (name_abbreviation) nested in kommune (municipality)


```{r}
#test lme4 is working
model <- lmer(pos_score_roberta ~ roberta_label + (1 | municipality), data=sentiment_data)
model
```


```{r}
#simple plotting
plot(pos_score_roberta ~ neg_score_roberta, data = sentiment_data, main = "pos_score_roberta ~ neg_score_roberta") 
```
```{r}
#First: check level of the outcome variable 
levels(sentiment_data$intervention)
#first level (here no) is encoded as 0 and the second level (here yes) is encoded as 1, estimates we are getting are **log odds of level 1** i.e. the probability of the intervention being yes 
```

read: https://rips-irsp.com/articles/10.5334/irsp.90

```{r}
#no mixed effects model
no_mixed_model <- glm(intervention ~ compound,family=binomial(link='logit'),data=sentiment_data)
summary(no_mixed_model)
#no random effects: assume all data are independent from each other (not the case here)


#simple model
# in logistic regression coefficients are a on log-oods scale = positive means increase in possibility
simple_model <- glmer(intervention ~ compound + (1| municipality), data = sentiment_data, family = binomial)
#log odds of intervention is predicted by compound score (fixed effect) allowing the model to vary by municipality 
summary(simple_model)
#when the compound score increase with 1 (more positive sentiment) the log odds of the intervention being yes decreases with -0.78, i.e. more positive sentiment entails a lower probability of the intervention being yes, in accordance with what the plots above are showing. 



#simple model 2
simple_model_2 <- glmer(intervention ~ compound + (1| name_abbreviation), data = sentiment_data, family = binomial)
#log odds of intervention is predicted by compound score (fixed effect) allowing the model to vary by politician  
summary(simple_model_2)




```






# predcting the sentiment, i.e. can the sentiment of the comments be predicted by e.g. municipality, n_likes, n_hearts, politician (name_abbreviation)

```{r}

```

